var MapEditor=function(){function t(t,e,a,i,s){s=s||["Background","Ground","Foreground"];var n,o=this;for(this.$selected=null,this.limit=a*i,this.width=t,this.height=e,this.limitX=a,this.limitY=i,this.panelIndex=0,this.mousedown=!1,this.deleteMousedown=!1,$("#map").css({height:e*i,width:t*a}),$("#wrap-map").scrollTop(e*i),n=0;n<s.length;n++)$("#map").append('<div data-layer="'+s[n]+'"></div>'),$("#select-layers").append('<option value="'+s[n]+'">'+s[n]+"</option>");for(n=0;n<this.limit;n++)$("#map > div").each(function(){$(this).append('<div class="tile" style="width:'+o.width+"px; height:"+o.height+"px; position: absolute; top:"+~~(n/o.limitX)*o.height+"px; left:"+n%o.limitX*o.width+'px;"></div>')});$("#ckb-grid").on("change",function(){$(this).is(":checked")?$("#map .grid").addClass("grid-show"):$("#map .grid").removeClass("grid-show")}).trigger("change"),$("#select-layers").on("change",function(){}).trigger("change"),$("#panel .panel-content").on("click",".tile",function(){$(".selected").removeClass("selected"),$(this).addClass("selected"),o.$selected=$(this)}),$("#panel .panel-top li a").on("click",function(){return $("#panel .panel-top li a").parent().removeClass("active"),$(this).parent().addClass("active"),$("#panel .panel-content > [id^=panel]").hide(),$($(this).attr("href")).show(),"#panel .panel-content-collision"==$(this).attr("href")?$("body").addClass("panel-collision"):$("body").removeClass("panel-collision"),$(".selected").removeClass("selected"),o.$selected=null,!1}),$("#map").on("mouseover",".tile",function(){$(this).attr("data-bg",$(this).css("background")),o.$selected&&$(this).css({background:o.$selected.css("background"),opacity:.8})}),$("#map").on("mouseout",".tile",function(){$(this).css({background:$(this).attr("data-bg")||"",opacity:1})}),$("#map").on("mousemove",".tile",function(){o.$selected&&o.mousedown&&($(this).css({background:o.$selected.css("background")}),$(this).attr("data-bg",o.$selected.css("background")),$(this).attr("data-has-bg","true")),o.deleteMousedown&&($(this).css({background:""}),$(this).attr("data-bg",""),$(this).attr("data-has-bg","false"))}),$("#map").on("mousedown",".tile",function(t){t.preventDefault(),o.$selected&&(2==t.which?($(this).css({background:""}),$(this).attr("data-bg",""),$(this).attr("data-has-bg","false")):($(this).css({background:o.$selected.css("background")}),$(this).attr("data-bg",o.$selected.css("background")),$(this).attr("data-has-bg","true")))}),$("#map").on(".collide","mousedown",function(t){t.preventDefault(),2==t.which&&$(this).remove()}),$(document).on("mousedown",function(t){$(t.target).is(".tile")&&(t.preventDefault(),1==t.which?o.mousedown=!0:2==t.which&&(o.deleteMousedown=!0))}).on("mouseup",function(t){t.preventDefault(),1==t.which?o.mousedown=!1:2==t.which&&(o.deleteMousedown=!1)}),$("#panel .panel-content .collide").css({width:t,height:e}).on("click",function(){}),$("#panel .panel-top li a:eq(0)").trigger("click")}return t.prototype.add=function(t){function e(){for(var e=o.panelIndex;n>e;e++)$("#panel-tile .tiles").append('<div class="tile" style="background: url('+t+") no-repeat -"+e%i*o.width+"px -"+~~(e/i)*o.height+"px; width:"+o.width+"px; height:"+o.height+'px; float: left; margin: 1px;"></div>');o.panelIndex=e}var a=new Image,i=0,s=0,n=0,o=this;a.onload=function(){i=this.width/o.width,s=this.height/o.height,n+=i*s,e()},a.src=t},t.prototype.export=function(){var t=$("#map").clone();return t.find(".tile").each(function(){var t=$(this).attr("data-has-bg");t&&"false"!=t||$(this).remove()}).removeAttr("class").removeAttr("data-bg").removeAttr("data-has-bg"),t.find(".collide").each(function(){$("> *",this).remove()}).removeAttr("class").removeAttr("data-body-initialized"),$("#modal-export textarea").val(t.html()),$("#modal-export").modal(),t.html()},t}();