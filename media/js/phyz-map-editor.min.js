var MapEditor=function(){function t(t,e,a,i,s){s=s||["Background","Ground","Foreground"];var o,n=this;for(this.$selected=null,this.limit=a*i,this.width=t,this.height=e,this.limitX=a,this.limitY=i,this.panelIndex=0,this.mousedown=!1,this.deleteMousedown=!1,$("#map").css({height:e*i,width:t*a}),$("#wrap-map").scrollTop(e*i),o=0;o<s.length;o++)$("#map").append('<div data-layer="'+s[o]+'"></div>'),$("#select-layers").append('<option value="'+s[o]+'">'+s[o]+"</option>");for(o=0;o<this.limit;o++)$("#map > div").each(function(){$(this).append('<div class="tile" style="width:'+n.width+"px; height:"+n.height+"px; position: absolute; top:"+~~(o/n.limitX)*n.height+"px; left:"+o%n.limitX*n.width+'px;"></div>')});$("#ckb-grid").on("change",function(){$(this).is(":checked")?$("#map .grid").addClass("grid-show"):$("#map .grid").removeClass("grid-show")}).trigger("change"),$("#select-layers").on("change",function(){$(this).is(":checked")?$("#map .grid").addClass("grid-show"):$("#map .grid").removeClass("grid-show")}).trigger("change"),$("#panel .panel-content").on("click",".body",function(){$(".selected").removeClass("selected"),$(this).addClass("selected"),n.$selected=$(this)}),$("#panel .panel-top li a").on("click",function(){return $("#panel .panel-top li a").parent().removeClass("active"),$(this).parent().addClass("active"),$("#panel .panel-content > [id^=panel]").hide(),$($(this).attr("href")).show(),"#panel .panel-content-collision"==$(this).attr("href")?$("body").addClass("panel-collision"):$("body").removeClass("panel-collision"),$(".selected").removeClass("selected"),n.$selected=null,!1}),$("#map").on("mouseover",".tile",function(){$(this).attr("data-bg",$(this).css("background")),n.$selected&&$(this).css({background:n.$selected.css("background"),opacity:.8})}),$("#map").on("mouseout",".tile",function(){$(this).css({background:$(this).attr("data-bg")||"",opacity:1})}),$("#map").on("mousemove",".tile",function(){n.$selected&&n.mousedown&&($(this).css({background:n.$selected.css("background")}),$(this).attr("data-bg",n.$selected.css("background")),$(this).attr("data-has-bg","true")),n.deleteMousedown&&($(this).css({background:""}),$(this).attr("data-bg",""),$(this).attr("data-has-bg","false"))}),$("#map").on("mousedown",".tile",function(t){t.preventDefault(),n.$selected&&(2==t.which?($(this).css({background:""}),$(this).attr("data-bg",""),$(this).attr("data-has-bg","false")):($(this).css({background:n.$selected.css("background")}),$(this).attr("data-bg",n.$selected.css("background")),$(this).attr("data-has-bg","true")))}),$("#map").on(".collide","mousedown",function(t){t.preventDefault(),2==t.which&&$(this).remove()}),$(document).on("mousedown",function(t){$(t.target).is(".tile")&&(t.preventDefault(),1==t.which?n.mousedown=!0:2==t.which&&(n.deleteMousedown=!0))}).on("mouseup",function(t){t.preventDefault(),1==t.which?n.mousedown=!1:2==t.which&&(n.deleteMousedown=!1)}),$("#panel .panel-content .collide").css({width:t,height:e}).on("click",function(){}),$("#panel .panel-top li a:eq(0)").trigger("click")}return t.prototype.add=function(t){function e(){for(var e=n.panelIndex;o>e;e++)$("#panel .panel-content-tile .tiles").append('<div class="body" style="background: url('+t+") no-repeat -"+e%i*n.width+"px -"+~~(e/i)*n.height+"px; width:"+n.width+"px; height:"+n.height+'px; float: left; margin: 1px;"></div>');n.panelIndex=e}var a=new Image,i=0,s=0,o=0,n=this;a.onload=function(){i=this.width/n.width,s=this.height/n.height,o+=i*s,e()},a.src=t},t.prototype.export=function(){var t=$("#map").clone();return t.find(".tile").each(function(){var t=$(this).attr("data-has-bg");t&&"false"!=t||$(this).remove()}).removeAttr("class").removeAttr("data-bg").removeAttr("data-has-bg"),t.find(".collide").each(function(){$("> *",this).remove()}).removeAttr("class").removeAttr("data-body-initialized"),$("#modal-export textarea").val(t.html()),$("#modal-export").modal(),t.html()},t}();